<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Patient Records</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #f4fbfb; }
  h2 { color: #0f7cff; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { padding: 12px; border: 1px solid #ccc; text-align: left; }
  th { background: #e0f2ff; }
  button { padding: 8px 12px; border: none; border-radius: 6px; background: #0f7cff; color: #fff; cursor: pointer; }
  button:hover { background: #005fcc; }
  input[type="file"] { margin-top: 10px; }
</style>
</head>
<body>
<h2>Patient Records</h2>

<div id="patientInfo"></div>

<!---<h3>Upload New Record</h3>
<input type="file" id="fileInput" />
<button id="uploadBtn">Upload</button>--->

<h3>Available Records</h3>
<table id="recordsTable">
  <thead>
    <tr><th>File Name</th><th>Link</th></tr>
  </thead>
  <tbody id="recordsBody">
    <tr><td colspan="2">Loading records...</td></tr>
  </tbody>
</table>

<script>
  
  const token = localStorage.getItem('token');
  if (!token) {
    alert('Not logged in!');
    window.location.href = 'login.html';
  }

  // Get patientId from URL query parameter
  // Determine patientId (for doctors, comes from query param)
  const urlParams = new URLSearchParams(window.location.search);
  let patientId = urlParams.get('patientId');
  console.log("Patient ID from URL:", patientId);
  if (patientId) {
    document.getElementById('patientInfo').textContent = `Patient ID: ${patientId}`;
  } else {
  // For patients viewing their own records
    document.getElementById('patientInfo').textContent = `Your Records`;
    patientId = ''; // Leave blank â†’ backend will infer from JWT
  }


  // Fetch and display records from backend API
  async function fetchRecords() {
  try {
    console.log("Fetching records for patientId:", patientId);
    const url = `/api/records${patientId ? `?patientId=${patientId}` : ''}`;
    console.log("Request URL:", url);

    const response = await fetch(url, {
      headers: { Authorization: 'Bearer ' + token }
    });

    console.log("Response status:", response.status);

    if (!response.ok) {
      const text = await response.text();
      console.error("Server error:", text);
      throw new Error(`Fetch failed: ${response.status}`);
    }

    const data = await response.json();
    console.log("Records received:", data);

    const tbody = document.getElementById('recordsBody');
    tbody.innerHTML = '';
    if (data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="2">No records found.</td></tr>';
      return;
    }
    data.forEach(record => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${record.fileName}</td><td><a href="${record.url}" target="_blank">View</a></td>`;
      tbody.appendChild(tr);
    });
  } catch (error) {
    console.error("FetchRecords error:", error);
    alert('Error loading records: ' + error.message);
  }
}


  // Upload new record to backend
  /*
  document.getElementById('uploadBtn').addEventListener('click', async () => {
    const fileInput = document.getElementById('fileInput');
    if (!fileInput.files.length) {
      alert('Please select a file first');
      return;
    }
    const file = fileInput.files[0];
    const formData = new FormData();
    formData.append('file', file);

    try {
      const response = await fetch('/api/records/upload', {
        method: 'POST',
        headers: { Authorization: 'Bearer ' + token },
        body: formData
      });
      if (!response.ok) {
        const err = await response.json();
        throw new Error(err.error || 'Upload failed');
      }
      alert('Upload successful');
      fileInput.value = '';
      fetchRecords();
    } catch (error) {
      console.error(error);
      alert('Error uploading record: ' + error.message);
    }
  });*/

  // Initial fetch on page load
  fetchRecords();
</script>

</body>
</html>
