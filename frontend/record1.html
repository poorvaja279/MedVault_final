<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Patient Records</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #f4fbfb; }
  h2 { color: #0f7cff; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { padding: 12px; border: 1px solid #ccc; text-align: left; }
  th { background: #e0f2ff; }
  button { padding: 8px 12px; border: none; border-radius: 6px; background: #0f7cff; color: #fff; cursor: pointer; }
  button:hover { background: #005fcc; }
  input[type="file"] { margin-top: 10px; }
</style>
</head>
<body>
<h2>Patient Records</h2>

<div id="patientInfo"></div>

<h3>Available Records</h3>
<table id="recordsTable">
  <thead>
    <tr><th>File Name</th><th>Link</th></tr>
  </thead>
  <tbody id="recordsBody">
    <tr><td colspan="2">Loading records...</td></tr>
  </tbody>
</table>

<script>
const token = localStorage.getItem('token');
if (!token) {
  alert('Not logged in!');
  window.location.href = 'login.html';
}

// Get patientId if doctor is viewing
const urlParams = new URLSearchParams(window.location.search);
let patientId = urlParams.get('patientId');

if (patientId) {
  document.getElementById('patientInfo').textContent = `Patient ID: ${patientId}`;
} else {
  document.getElementById('patientInfo').textContent = `Your Records`;
  patientId = ''; // patient view â†’ backend infers from token
}

async function fetchRecords() {
  try {
    const baseURL = "https://medvault-backend-vfsu.onrender.com/api/records";
    const url = patientId ? `${baseURL}?patientId=${patientId}` : baseURL;

    const response = await fetch(url, {
      headers: { Authorization: 'Bearer ' + token }
    });

    if (!response.ok) {
      const text = await response.text();
      throw new Error(`Error: ${response.status} ${text}`);
    }

    const data = await response.json();
    const tbody = document.getElementById('recordsBody');
    tbody.innerHTML = '';

    if (data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="2">No records found.</td></tr>';
      return;
    }

    data.forEach(record => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${record.fileName}</td><td><a href="${record.url}" target="_blank">View</a></td>`;
      tbody.appendChild(tr);
    });

  } catch (error) {
    console.error("Error loading records:", error);
    alert('Error loading records: ' + error.message);
  }
}

// Load on page open
fetchRecords();
</script>

</body>
</html>
